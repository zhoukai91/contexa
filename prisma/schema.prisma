generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum TranslationStatus {
  pending
  needs_update
  needs_review
  ready
  approved
}

enum GlossaryTermType {
  recommended
  forced
}

enum GlossaryItemStatus {
  enabled
  disabled
}

model SystemMeta {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model User {
  id            Int       @id @default(autoincrement())
  name          String?
  account       String    @unique
  passwordHash  String
  role          String    @default("member")
  isSystemAdmin Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  teamMembers       TeamMember[]
  invitationsSent   Invitation[]     @relation("InvitationInvitedBy")
  activityLogs      ActivityLog[]
  projectMembers    ProjectMember[]
  translationLocks  TranslationPageLock[]
  projectsCreated   Project[]        @relation("ProjectCreatedBy")
  projectInvitationsSent ProjectInvitation[] @relation("ProjectInvitationInvitedBy")
  localePreferences UserProjectLocalePreference[]

  packageUploads PackageUpload[]
  glossaryTermsCreated ProjectGlossaryTerm[] @relation("GlossaryTermCreatedBy")
  glossaryTermsUpdated ProjectGlossaryTerm[] @relation("GlossaryTermUpdatedBy")
  negativePromptsCreated ProjectNegativePrompt[] @relation("NegativePromptCreatedBy")
  negativePromptsUpdated ProjectNegativePrompt[] @relation("NegativePromptUpdatedBy")
}

model Team {
  id                 Int      @id @default(autoincrement())
  name               String
  stripeCustomerId   String?  @unique
  stripeSubscriptionId String? @unique
  stripeProductId    String?
  planName           String?
  subscriptionStatus String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  teamMembers  TeamMember[]
  activityLogs ActivityLog[]
  invitations  Invitation[]
}

model TeamMember {
  id       Int      @id @default(autoincrement())
  userId   Int
  teamId   Int
  role     String
  joinedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  team Team @relation(fields: [teamId], references: [id])
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  teamId    Int
  userId    Int?
  action    String
  timestamp DateTime @default(now())
  ipAddress String?

  team Team  @relation(fields: [teamId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
}

model Invitation {
  id        Int      @id @default(autoincrement())
  teamId    Int
  account   String
  role      String
  invitedBy Int
  invitedAt DateTime @default(now())
  status    String   @default("pending")

  team Team @relation(fields: [teamId], references: [id])
  inviter User @relation("InvitationInvitedBy", fields: [invitedBy], references: [id])

  @@index([teamId, status])
}

model Project {
  id           Int      @id @default(autoincrement())
  name         String
  createdByUserId Int?
  sourceLocale String
  description  String?
  qualityMode  String   @default("standard")
  translationAdapter String @default("tbd")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  locales     ProjectLocale[]
  members     ProjectMember[]
  entries     Entry[]
  translations Translation[]
  pages       Page[]
  locks       TranslationPageLock[]
  packageUploads PackageUpload[]
  settings    ProjectSetting[]
  createdBy   User?    @relation("ProjectCreatedBy", fields: [createdByUserId], references: [id])
  invitations ProjectInvitation[]
  localePreferences UserProjectLocalePreference[]
  glossaryTerms ProjectGlossaryTerm[]
  negativePrompts ProjectNegativePrompt[]

  @@unique([name])
}

model ProjectSetting {
  id          Int      @id @default(autoincrement())
  projectId   Int
  key         String
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@unique([projectId, key])
  @@index([projectId])
}

model ProjectLocale {
  id        Int      @id @default(autoincrement())
  projectId Int
  locale    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  translations Translation[]
  locks TranslationPageLock[]
  glossaryTerms ProjectGlossaryTerm[]
  negativePrompts ProjectNegativePrompt[]
  packageUploads PackageUpload[]

  @@unique([projectId, locale])
  @@index([projectId])
}

model ProjectMember {
  id         Int      @id @default(autoincrement())
  projectId  Int
  userId     Int
  role       String
  canReview  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
}

model ProjectInvitation {
  id        Int      @id @default(autoincrement())
  projectId Int
  account   String
  role      String
  canReview Boolean  @default(false)
  invitedBy Int
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  inviter User    @relation("ProjectInvitationInvitedBy", fields: [invitedBy], references: [id])

  @@unique([projectId, account])
  @@index([projectId, status])
}

model UserProjectLocalePreference {
  id        Int      @id @default(autoincrement())
  userId    Int
  projectId Int
  locale    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  @@unique([userId, projectId, locale])
  @@index([projectId, userId])
}

model Entry {
  id          Int      @id @default(autoincrement())
  projectId   Int
  key         String
  sourceText  String
  sourceLocale String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project      Project        @relation(fields: [projectId], references: [id])
  translations Translation[]
  placements   EntryPlacement[]

  @@unique([projectId, key])
  @@index([projectId])
}

model Translation {
  id        Int              @id @default(autoincrement())
  entryId   Int
  projectId Int
  locale    String
  text      String?
  status    TranslationStatus @default(pending)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  entry   Entry   @relation(fields: [entryId], references: [id])
  project Project @relation(fields: [projectId], references: [id])
  projectLocale ProjectLocale @relation(fields: [projectId, locale], references: [projectId, locale])

  @@unique([entryId, locale])
  @@index([projectId, locale, status])
}

model Page {
  id        Int      @id @default(autoincrement())
  projectId Int
  route     String
  title     String?
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project     Project        @relation(fields: [projectId], references: [id])
  modules     Module[]
  locks       TranslationPageLock[]

  @@unique([projectId, route])
}

model Module {
  id        Int      @id @default(autoincrement())
  pageId    Int
  name      String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  page       Page            @relation(fields: [pageId], references: [id])
  placements EntryPlacement[]

  @@unique([pageId, name])
}

model EntryPlacement {
  id       Int  @id @default(autoincrement())
  entryId  Int
  moduleId Int

  entry  Entry  @relation(fields: [entryId], references: [id])
  module Module @relation(fields: [moduleId], references: [id])

  @@unique([entryId, moduleId])
  @@index([moduleId])
}

model TranslationPageLock {
  id        Int      @id @default(autoincrement())
  projectId Int
  pageId    Int
  locale    String
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  page    Page    @relation(fields: [pageId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  projectLocale ProjectLocale @relation(fields: [projectId, locale], references: [projectId, locale])

  @@unique([projectId, pageId, locale])
  @@index([userId, expiresAt])
}

model ProjectGlossaryTerm {
  id              Int              @id @default(autoincrement())
  projectId        Int
  locale           String
  source           String
  target           String
  type             GlossaryTermType   @default(recommended)
  status           GlossaryItemStatus @default(enabled)
  note             String?
  createdByUserId  Int?
  updatedByUserId  Int?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  project   Project @relation(fields: [projectId], references: [id])
  createdBy User?   @relation("GlossaryTermCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy User?   @relation("GlossaryTermUpdatedBy", fields: [updatedByUserId], references: [id])
  projectLocale ProjectLocale @relation(fields: [projectId, locale], references: [projectId, locale])

  @@unique([projectId, locale, source])
  @@index([projectId, locale])
  @@index([projectId, locale, status])
}

model ProjectNegativePrompt {
  id              Int              @id @default(autoincrement())
  projectId        Int
  locale           String
  phrase           String
  alternative      String?
  note             String?
  status           GlossaryItemStatus @default(enabled)
  createdByUserId  Int?
  updatedByUserId  Int?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  project   Project @relation(fields: [projectId], references: [id])
  createdBy User?   @relation("NegativePromptCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy User?   @relation("NegativePromptUpdatedBy", fields: [updatedByUserId], references: [id])
  projectLocale ProjectLocale @relation(fields: [projectId, locale], references: [projectId, locale])

  @@unique([projectId, locale, phrase])
  @@index([projectId, locale])
  @@index([projectId, locale, status])
}

model PackageUpload {
  id              Int      @id @default(autoincrement())
  projectId        Int
  locale           String
  shape            String
  createdByUserId  Int?
  createdAt        DateTime @default(now())

  summaryAdded            Int @default(0)
  summaryUpdated          Int @default(0)
  summaryMissing          Int @default(0)
  summaryIgnored          Int @default(0)
  summaryMarkedNeedsUpdate Int @default(0)
  summarySkippedEmpty     Int @default(0)

  detailsJson      String?

  project   Project @relation(fields: [projectId], references: [id])
  createdBy User?   @relation(fields: [createdByUserId], references: [id])
  projectLocale ProjectLocale @relation(fields: [projectId, locale], references: [projectId, locale])

  @@index([projectId, createdAt])
  @@index([createdByUserId, createdAt])
}
